<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIåŠ©æ‰‹ç¾¤èŠ - çœŸå®APIç‰ˆæœ¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .api-config {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .api-config h3 {
            color: #374151;
            margin-bottom: 15px;
        }

        .api-input-group {
            margin-bottom: 15px;
        }

        .api-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }

        .api-input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .api-input-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .toggle-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
        }

        .toggle-button:hover {
            background: #2563eb;
        }

        .toggle-button.active {
            background: #10b981;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .assistant-list {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .assistant-list h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 15px;
        }

        .assistant-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: border-color 0.2s;
        }

        .assistant-item:hover {
            border-color: #d1d5db;
        }

        .assistant-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
            font-weight: 600;
        }

        .assistant-info h4 {
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .assistant-info p {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.online {
            background: #10b981;
        }

        .status-dot.offline {
            background: #ef4444;
        }

        .chat-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            height: 600px;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .chat-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .chat-header p {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 300px;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 0.875rem;
            line-height: 1.4;
            white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
            word-break: break-word; /* é•¿è¯æ¢è¡Œ */
        }

        .message.user .message-content {
            background: #3b82f6;
            color: white;
            border-bottom-right-radius: 6px;
        }

        .message.assistant .message-content {
            background: white;
            color: #374151;
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 6px;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
            font-weight: 600;
        }

        .message-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .message-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
        }

        .message-time {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: #3b82f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .loading {
            display: flex;
            justify-content: center;
            gap: 4px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            background: #9ca3af;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .chat-input {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .input-form {
            display: flex;
            gap: 12px;
        }

        .input-field {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.875rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .send-button {
            padding: 12px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .send-button:hover {
            background: #2563eb;
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .send-icon {
            width: 16px;
            height: 16px;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AIåŠ©æ‰‹ç¾¤èŠ - çœŸå®APIç‰ˆæœ¬</h1>
            <p>é…ç½®çœŸå®çš„AI APIå¯†é’¥ï¼Œä½“éªŒçœŸå®çš„AIå¯¹è¯</p>
        </div>

        <!-- APIé…ç½®åŒºåŸŸ -->
        <div class="api-config">
            <h3>ğŸ”‘ APIé…ç½®</h3>
            <div class="api-input-group">
                <label for="deepseekApiKey">DeepSeek API Key:</label>
                <input type="password" id="deepseekApiKey" placeholder="è¾“å…¥ä½ çš„DeepSeek APIå¯†é’¥">
            </div>
            <div class="api-input-group">
                <label for="tongyiApiKey">é€šä¹‰åƒé—® API Key:</label>
                <input type="password" id="tongyiApiKey" placeholder="è¾“å…¥ä½ çš„é€šä¹‰åƒé—®APIå¯†é’¥">
            </div>
            <div class="api-input-group">
                <label for="doubaoApiKey">è±†åŒ… API Key:</label>
                <input type="password" id="doubaoApiKey" placeholder="è¾“å…¥ä½ çš„è±†åŒ…APIå¯†é’¥">
            </div>
            <button id="defaultKeyToggle" class="toggle-button" type="button">ä½¿ç”¨é»˜è®¤Keyæ¨¡å¼ï¼šå…³é—­</button>
            <button id="plainTextToggle" class="toggle-button active" type="button">çº¯æ–‡æœ¬æ˜¾ç¤ºï¼šå¼€å¯</button>
            <button id="conciseModeToggle" class="toggle-button" type="button">ç®€æ´æ¨¡å¼ï¼šå…³é—­</button>
            
            <!-- API-only æ¨¡å¼ï¼Œå·²ç§»é™¤æ¨¡æ‹Ÿ/çœŸå®åˆ‡æ¢ -->
            
            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </div>

        <div class="main-content">
            <div class="assistant-list">
                <h3>AIåŠ©æ‰‹ç¾¤ç»„</h3>
                <div class="assistant-item">
                    <div class="assistant-avatar" style="background-color: #3B82F6;">ğŸ¤–</div>
                    <div class="assistant-info">
                        <h4>DeepSeek</h4>
                        <p>å¼ºå¤§çš„AIåŠ©æ‰‹ï¼Œæ“…é•¿ä»£ç ç”Ÿæˆå’Œé—®é¢˜è§£ç­”</p>
                    </div>
                    <div class="status-dot" id="deepseekStatus"></div>
                </div>
                <div class="assistant-item">
                    <div class="assistant-avatar" style="background-color: #10B981;">ğŸ§ </div>
                    <div class="assistant-info">
                        <h4>é€šä¹‰åƒé—®</h4>
                        <p>é˜¿é‡Œäº‘æ™ºèƒ½åŠ©æ‰‹ï¼ŒçŸ¥è¯†æ¸Šåšï¼Œå›ç­”å‡†ç¡®</p>
                    </div>
                    <div class="status-dot" id="tongyiStatus"></div>
                </div>
                        <div class="assistant-item">
            <div class="assistant-avatar" style="background-color: #FF6B35;">ğŸœ</div>
            <div class="assistant-info">
                <h4>è±†åŒ…</h4>
                <p>å­—èŠ‚è·³åŠ¨çš„AIåŠ©æ‰‹ï¼ŒçŸ¥è¯†ä¸°å¯Œï¼Œå›ç­”å‡†ç¡®</p>
            </div>
            <div class="status-dot" id="doubaoStatus"></div>
        </div>
            </div>

            <div class="chat-container">
                <div class="chat-header">
                    <h2>AIåŠ©æ‰‹ç¾¤èŠ</h2>
                    <p id="onlineCount">3 ä¸ªAIåŠ©æ‰‹åœ¨çº¿</p>
                </div>

                <div class="messages-container" id="messagesContainer">
                    <div class="message assistant">
                        <div class="message-avatar" style="background-color: #3B82F6;">ğŸ¤–</div>
                        <div class="message-content">
                            <div class="message-info">
                                <span class="message-name">DeepSeek</span>
                                <span class="message-time" id="time1"></span>
                            </div>
                            <p>æ¬¢è¿æ¥åˆ°AIåŠ©æ‰‹ç¾¤èŠï¼æˆ‘æ˜¯DeepSeekï¼Œå¾ˆé«˜å…´ä¸ºä½ æä¾›å¸®åŠ©ï¼</p>
                        </div>
                    </div>
                    <div class="message assistant">
                        <div class="message-avatar" style="background-color: #10B981;">ğŸ§ </div>
                        <div class="message-content">
                            <div class="message-info">
                                <span class="message-name">é€šä¹‰åƒé—®</span>
                                <span class="message-time" id="time2"></span>
                            </div>
                            <p>ä½ å¥½ï¼æˆ‘æ˜¯é€šä¹‰åƒé—®ï¼Œæ¥è‡ªé˜¿é‡Œäº‘ã€‚æˆ‘å¯ä»¥å¸®åŠ©ä½ è§£ç­”å„ç§é—®é¢˜ï¼</p>
                        </div>
                    </div>
                    <div class="message assistant">
                        <div class="message-avatar" style="background-color: #FF6B35;">ğŸœ</div>
                        <div class="message-content">
                            <div class="message-info">
                                <span class="message-name">è±†åŒ…</span>
                                <span class="message-time" id="time3"></span>
                            </div>
                            <p>ä½ å¥½ï¼æˆ‘æ˜¯è±†åŒ…ï¼Œæ¥è‡ªå­—èŠ‚è·³åŠ¨ã€‚æˆ‘çŸ¥è¯†ä¸°å¯Œï¼Œå¯ä»¥å¸®ä½ è§£ç­”å„ç§é—®é¢˜ï¼</p>
                        </div>
                    </div>
                </div>

                <div class="chat-input">
                    <form class="input-form" id="chatForm">
                        <input 
                            type="text" 
                            class="input-field" 
                            id="messageInput" 
                            placeholder="è¾“å…¥ä½ çš„é—®é¢˜..."
                            required
                        >
                        <button type="submit" class="send-button" id="sendButton">
                            <svg class="send-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                            å‘é€
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡ï¼ˆAPI-only æ¨¡å¼ï¼‰
        let apiKeys = {
            deepseek: '',
            tongyi: '',
            doubao: ''
        };

        // é»˜è®¤Keyæ¨¡å¼ï¼ˆç”¨äºæ¼”ç¤º/å¿«é€Ÿä½“éªŒï¼‰
        let useDefaultKeys = false;
        const defaultApiKeys = {
            deepseek: 'sk-11a35677deac466c9870cc2f378b7a8d',
            tongyi: 'sk-25589eb8818943cabe6d1356da901cd4',
            doubao: '0d76b879-92cf-4964-ba29-380e452e9908'
        };

        // ç®€æ´æ¨¡å¼å¼€å…³ï¼Œé»˜è®¤å…³é—­
        let useConciseMode = false;

        // ä¸‰ä¸ªå®˜ç½‘ API åœ°å€ï¼ˆé›†ä¸­ç®¡ç†ï¼‰
        const apiEndpoints = {
            deepseek: 'https://api.deepseek.com/v1/chat/completions',
            tongyi: 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',
            doubao: 'https://ark.cn-beijing.volces.com/api/v3/chat/completions'
        };

        // çº¯æ–‡æœ¬æ˜¾ç¤ºï¼ˆå¾®ä¿¡èŠå¤©é£æ ¼ï¼‰å¼€å…³ï¼Œé»˜è®¤å¼€å¯
        let usePlainText = true;

        // èŠå¤©å†å²ï¼ˆç”¨äºä¸Šä¸‹æ–‡ï¼‰
        // ä½¿ç”¨ OpenAI å…¼å®¹çš„ { role, content } ç»“æ„
        const chatHistory = [];

        // è·å–æœ€è¿‘ N æ¡æ¶ˆæ¯ï¼Œå¹¶å¯é€‰æ·»åŠ ç³»ç»Ÿæç¤º
        function getRecentMessages(limit = 20, systemPrompt = null) {
            const startIndex = Math.max(chatHistory.length - limit, 0);
            const recent = chatHistory.slice(startIndex);
            // ç®€æ´æ¨¡å¼ä¸‹çš„ç³»ç»Ÿæç¤º
            let finalSystemPrompt = systemPrompt;
            if (useConciseMode) {
                const concisePrompt = "ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„æœ‹å‹ï¼Œè¯·ç”¨ç®€æ´çš„è¯­è¨€å›å¤ï¼Œæ¯æ¬¡åªå›å¤1-2å¥è¯ï¼Œä¿æŒå¯¹è¯çš„è‡ªç„¶æµç•…ã€‚";
                finalSystemPrompt = finalSystemPrompt ? `${finalSystemPrompt}\n\n${concisePrompt}` : concisePrompt;
            }
            if (finalSystemPrompt) {
                return [{ role: 'system', content: finalSystemPrompt }, ...recent];
            }
            return recent;
        }

        // è®¾ç½®åˆå§‹æ¶ˆæ¯æ—¶é—´
        function setInitialTimes() {
            const now = new Date();
            const time1 = document.getElementById('time1');
            const time2 = document.getElementById('time2');
            const time3 = document.getElementById('time3');
            
            time1.textContent = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            time2.textContent = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            time3.textContent = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }

        // å·²ç§»é™¤æ¨¡å¼åˆ‡æ¢ï¼ˆå›ºå®šä¸ºçœŸå®APIæ¨¡å¼ï¼‰

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus() {
            const deepseekStatus = document.getElementById('deepseekStatus');
            const tongyiStatus = document.getElementById('tongyiStatus');
            const doubaoStatus = document.getElementById('doubaoStatus');
            
            const effectiveKeys = getEffectiveKeys();
            deepseekStatus.className = 'status-dot ' + (effectiveKeys.deepseek ? 'online' : 'offline');
            tongyiStatus.className = 'status-dot ' + (effectiveKeys.tongyi ? 'online' : 'offline');
            doubaoStatus.className = 'status-dot ' + (effectiveKeys.doubao ? 'online' : 'offline');
            
            // æ›´æ–°åœ¨çº¿æ•°é‡
            const onlineCount = document.getElementById('onlineCount');
            const onlineAssistants = Object.values(effectiveKeys).filter(key => key).length;
            onlineCount.textContent = `${onlineAssistants} ä¸ªAIåŠ©æ‰‹åœ¨çº¿`;
        }

        // è·å–æœ‰æ•ˆKeyï¼šä¼˜å…ˆç”¨æˆ·è¾“å…¥ï¼Œå…¶æ¬¡é»˜è®¤Key
        function getEffectiveKeys() {
            return {
                deepseek: apiKeys.deepseek || defaultApiKeys.deepseek,
                tongyi: apiKeys.tongyi || defaultApiKeys.tongyi,
                doubao: apiKeys.doubao || defaultApiKeys.doubao
            };
        }

        // ä¿å­˜APIå¯†é’¥
        function saveApiKeys() {
            apiKeys.deepseek = document.getElementById('deepseekApiKey').value;
            apiKeys.tongyi = document.getElementById('tongyiApiKey').value;
            apiKeys.doubao = document.getElementById('doubaoApiKey').value;
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('aiChatApiKeys', JSON.stringify(apiKeys));
            
            updateStatus();
        }

        // åŠ è½½ä¿å­˜çš„é…ç½®
        function loadSavedConfig() {
            const savedKeys = localStorage.getItem('aiChatApiKeys');
            
            if (savedKeys) {
                apiKeys = JSON.parse(savedKeys);
                document.getElementById('deepseekApiKey').value = apiKeys.deepseek;
                document.getElementById('tongyiApiKey').value = apiKeys.tongyi;
                document.getElementById('doubaoApiKey').value = apiKeys.doubao;
            }
            const savedUseDefault = localStorage.getItem('aiChatUseDefaultKeys');
            if (savedUseDefault) {
                useDefaultKeys = savedUseDefault === 'true';
            }
            const toggleBtn = document.getElementById('defaultKeyToggle');
            if (useDefaultKeys) {
                toggleBtn.classList.add('active');
                toggleBtn.textContent = 'ä½¿ç”¨é»˜è®¤Keyæ¨¡å¼ï¼šå¼€å¯';
            } else {
                toggleBtn.classList.remove('active');
                toggleBtn.textContent = 'ä½¿ç”¨é»˜è®¤Keyæ¨¡å¼ï¼šå…³é—­';
            }
            
            updateStatus();

            const savedPlain = localStorage.getItem('aiChatUsePlainText');
            if (savedPlain) {
                usePlainText = savedPlain === 'true';
            }
            const plainBtn = document.getElementById('plainTextToggle');
            if (usePlainText) {
                plainBtn.classList.add('active');
                plainBtn.textContent = 'çº¯æ–‡æœ¬æ˜¾ç¤ºï¼šå¼€å¯';
            } else {
                plainBtn.classList.remove('active');
                plainBtn.textContent = 'çº¯æ–‡æœ¬æ˜¾ç¤ºï¼šå…³é—­';
            }

            const savedConcise = localStorage.getItem('aiChatUseConciseMode');
            if (savedConcise) {
                useConciseMode = savedConcise === 'true';
            }
            const conciseBtn = document.getElementById('conciseModeToggle');
            if (useConciseMode) {
                conciseBtn.classList.add('active');
                conciseBtn.textContent = 'ç®€æ´æ¨¡å¼ï¼šå¼€å¯';
            } else {
                conciseBtn.classList.remove('active');
                conciseBtn.textContent = 'ç®€æ´æ¨¡å¼ï¼šå…³é—­';
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // AIåŠ©æ‰‹é…ç½®ï¼ˆAPI-onlyï¼‰
        const assistants = [
            { id: 'deepseek', name: 'DeepSeek', avatar: 'ğŸ¤–', color: '#3B82F6' },
            { id: 'tongyi', name: 'é€šä¹‰åƒé—®', avatar: 'ğŸ§ ', color: '#10B981' },
            { id: 'doubao', name: 'è±†åŒ…', avatar: 'ğŸœ', color: '#FF6B35' }
        ];

        // å·²ç§»é™¤æ¨¡æ‹ŸAIæ¨¡å—

        // è°ƒç”¨çœŸå®API
        async function callRealAPI(messages, assistantId) {
            // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„APIæ–‡æ¡£æ¥å®ç°
            // ä»¥ä¸‹æ˜¯ç¤ºä¾‹ä»£ç ï¼Œä½ éœ€è¦æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹
            
            try {
                switch(assistantId) {
                    case 'deepseek':
                        if (!getEffectiveKeys().deepseek) {
                            throw new Error('DeepSeek APIå¯†é’¥æœªé…ç½®');
                        }
                        // è°ƒç”¨DeepSeek API
                        return await callDeepSeekAPI(messages, getEffectiveKeys().deepseek);
                        
                    case 'tongyi':
                        if (!getEffectiveKeys().tongyi) {
                            throw new Error('é€šä¹‰åƒé—®APIå¯†é’¥æœªé…ç½®');
                        }
                        // è°ƒç”¨é€šä¹‰åƒé—®API
                        return await callTongyiAPI(messages, getEffectiveKeys().tongyi);
                        
                    case 'doubao':
                        if (!getEffectiveKeys().doubao) {
                            throw new Error('è±†åŒ…APIå¯†é’¥æœªé…ç½®');
                        }
                        // è°ƒç”¨è±†åŒ…API
                        return await calldoubaoAPI(messages, getEffectiveKeys().doubao);
                        
                    default:
                        throw new Error('æœªçŸ¥çš„AIåŠ©æ‰‹');
                }
            } catch (error) {
                console.error(`è°ƒç”¨${assistantId} APIå¤±è´¥:`, error);
                return `æŠ±æ­‰ï¼Œè°ƒç”¨${assistantId} APIæ—¶å‡ºç°é”™è¯¯: ${error.message}`;
            }
        }

        // ç¤ºä¾‹APIè°ƒç”¨å‡½æ•°ï¼ˆéœ€è¦æ ¹æ®å®é™…APIæ–‡æ¡£ä¿®æ”¹ï¼‰
        async function callDeepSeekAPI(messages, apiKey) {
            // è¿™é‡Œéœ€è¦æ ¹æ®DeepSeekçš„å®é™…APIæ–‡æ¡£æ¥å®ç°
            // ç¤ºä¾‹ï¼š
            const requestBody = {
                model: 'deepseek-chat',
                messages: messages
            };
            
            // ç®€æ´æ¨¡å¼ä¸‹é™åˆ¶å›å¤é•¿åº¦
            if (useConciseMode) {
                requestBody.max_tokens = 100;
                requestBody.temperature = 0.7;
            }
            
            const response = await fetch(apiEndpoints.deepseek, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }

        async function callTongyiAPI(messages, apiKey) {
            // DashScope å…¼å®¹æ¨¡å¼ï¼ˆOpenAI é£æ ¼ï¼‰
            const requestBody = {
                model: 'qwen-plus',
                messages: messages
            };
            
            // ç®€æ´æ¨¡å¼ä¸‹é™åˆ¶å›å¤é•¿åº¦
            if (useConciseMode) {
                requestBody.max_tokens = 100;
                requestBody.temperature = 0.7;
            }
            
            const response = await fetch(apiEndpoints.tongyi, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status} - ${errorText}`);
            }
            
            const data = await response.json();
            const content = data?.choices?.[0]?.message?.content;
            if (content) return content;
            throw new Error('APIå“åº”æ ¼å¼ä¸æ­£ç¡®');
        }

        async function calldoubaoAPI(messages, apiKey) {
            // è±†åŒ…APIè°ƒç”¨ - å°è¯•å¤šä¸ªå¯èƒ½çš„æ¨¡å‹åç§°
            const possibleModels = [
                "doubao-seed-1-6-250615",
            ];
            
            for (const model of possibleModels) {
                try {
                    console.log(`å°è¯•è±†åŒ…æ¨¡å‹: ${model}`);
                    
                    const requestBody = {
                        model: model,
                        messages: messages,
                        max_tokens: 1000,
                        temperature: 0.7
                    };
                    
                    // ç®€æ´æ¨¡å¼ä¸‹è¿›ä¸€æ­¥é™åˆ¶å›å¤é•¿åº¦
                    if (useConciseMode) {
                        requestBody.max_tokens = 100;
                    }
                    
                    const response = await fetch(apiEndpoints.doubao, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.log(`æ¨¡å‹ ${model} å¤±è´¥: ${response.status} - ${errorText}`);
                        continue; // å°è¯•ä¸‹ä¸€ä¸ªæ¨¡å‹
                    }
                    
                    const data = await response.json();
                    console.log(`æ¨¡å‹ ${model} æˆåŠŸ!`);
                    
                    // æ ¹æ®è±†åŒ…APIçš„å“åº”æ ¼å¼è§£æ
                    if (data.choices && data.choices[0] && data.choices[0].message) {
                        return data.choices[0].message.content;
                    } else if (data.output && data.output.text) {
                        return data.output.text;
                    } else {
                        throw new Error('APIå“åº”æ ¼å¼ä¸æ­£ç¡®');
                    }
                } catch (error) {
                    console.log(`æ¨¡å‹ ${model} å‡ºé”™:`, error.message);
                    continue; // å°è¯•ä¸‹ä¸€ä¸ªæ¨¡å‹
                }
            }
            
            // æ‰€æœ‰æ¨¡å‹éƒ½å¤±è´¥äº†
            throw new Error('æ‰€æœ‰è±†åŒ…æ¨¡å‹éƒ½æ— æ³•è®¿é—®ï¼Œè¯·æ£€æŸ¥APIå¯†é’¥å’Œæƒé™');
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function addMessage(content, sender, assistantId = null) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            if (sender === 'user') {
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                if (usePlainText) {
                    contentDiv.textContent = content;
                } else {
                    contentDiv.innerHTML = `<p>${content}</p>`;
                }
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'user-avatar';
                avatarDiv.textContent = 'æˆ‘';
                messageDiv.appendChild(contentDiv);
                messageDiv.appendChild(avatarDiv);
            } else {
                const assistant = assistants.find(a => a.id === assistantId);
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.style.backgroundColor = assistant.color;
                avatar.textContent = assistant.avatar;
                const contentWrap = document.createElement('div');
                contentWrap.className = 'message-content';
                const info = document.createElement('div');
                info.className = 'message-info';
                const nameSpan = document.createElement('span');
                nameSpan.className = 'message-name';
                nameSpan.textContent = assistant.name;
                const timeSpan = document.createElement('span');
                timeSpan.className = 'message-time';
                timeSpan.textContent = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                info.appendChild(nameSpan);
                info.appendChild(timeSpan);
                contentWrap.appendChild(info);
                const p = document.createElement('p');
                if (usePlainText) {
                    p.textContent = content;
                } else {
                    p.innerHTML = content;
                }
                contentWrap.appendChild(p);
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(contentWrap);
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            const messagesContainer = document.getElementById('messagesContainer');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.id = 'loading';
            loadingDiv.innerHTML = `
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            `;
            messagesContainer.appendChild(loadingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.remove();
            }
        }

        // å¤„ç†è¡¨å•æäº¤
        document.getElementById('chatForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(message, 'user');
            // å†™å…¥å†å²ä½œä¸ºä¸Šä¸‹æ–‡
            chatHistory.push({ role: 'user', content: message });
            input.value = '';
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoading();
            
            try {
                let remaining = assistants.length;
                assistants.forEach(async (assistant) => {
                    try {
                        // å¯é€‰ç³»ç»Ÿæç¤ºï¼Œå¯æŒ‰éœ€å®šåˆ¶ä¸åŒåŠ©æ‰‹èº«ä»½
                        const systemPrompt = null;
                        const messagesWithContext = getRecentMessages(20, systemPrompt);
                        const response = await callRealAPI(messagesWithContext, assistant.id);
                        addMessage(response, 'assistant', assistant.id);
                        // å°†åŠ©æ‰‹å›å¤å†™å…¥å†å²
                        chatHistory.push({ role: 'assistant', content: response });
                    } catch (error) {
                        addMessage(`é”™è¯¯: ${error.message}`, 'assistant', assistant.id);
                    } finally {
                        remaining -= 1;
                        if (remaining === 0) {
                            hideLoading();
                        }
                    }
                });
            } catch (error) {
                hideLoading();
                showError(`å‘é€æ¶ˆæ¯å¤±è´¥: ${error.message}`);
            }
        });

        // ç›‘å¬APIå¯†é’¥è¾“å…¥å˜åŒ–
        document.getElementById('deepseekApiKey').addEventListener('input', saveApiKeys);
        document.getElementById('tongyiApiKey').addEventListener('input', saveApiKeys);
        document.getElementById('doubaoApiKey').addEventListener('input', saveApiKeys);
        // ç›‘å¬é»˜è®¤Keyæ¨¡å¼åˆ‡æ¢
        document.getElementById('defaultKeyToggle').addEventListener('click', function() {
            useDefaultKeys = !useDefaultKeys;
            localStorage.setItem('aiChatUseDefaultKeys', useDefaultKeys ? 'true' : 'false');
            const toggleBtn = document.getElementById('defaultKeyToggle');
            if (useDefaultKeys) {
                toggleBtn.classList.add('active');
                toggleBtn.textContent = 'ä½¿ç”¨é»˜è®¤Keyæ¨¡å¼ï¼šå¼€å¯';
            } else {
                toggleBtn.classList.remove('active');
                toggleBtn.textContent = 'ä½¿ç”¨é»˜è®¤Keyæ¨¡å¼ï¼šå…³é—­';
            }
            updateStatus();
        });

        // ç›‘å¬çº¯æ–‡æœ¬æ˜¾ç¤ºåˆ‡æ¢
        document.getElementById('plainTextToggle').addEventListener('click', function() {
            usePlainText = !usePlainText;
            localStorage.setItem('aiChatUsePlainText', usePlainText ? 'true' : 'false');
            const btn = document.getElementById('plainTextToggle');
            if (usePlainText) {
                btn.classList.add('active');
                btn.textContent = 'çº¯æ–‡æœ¬æ˜¾ç¤ºï¼šå¼€å¯';
            } else {
                btn.classList.remove('active');
                btn.textContent = 'çº¯æ–‡æœ¬æ˜¾ç¤ºï¼šå…³é—­';
            }
        });

        // ç›‘å¬ç®€æ´æ¨¡å¼åˆ‡æ¢
        document.getElementById('conciseModeToggle').addEventListener('click', function() {
            useConciseMode = !useConciseMode;
            localStorage.setItem('aiChatUseConciseMode', useConciseMode ? 'true' : 'false');
            const btn = document.getElementById('conciseModeToggle');
            if (useConciseMode) {
                btn.classList.add('active');
                btn.textContent = 'ç®€æ´æ¨¡å¼ï¼šå¼€å¯';
            } else {
                btn.classList.remove('active');
                btn.textContent = 'ç®€æ´æ¨¡å¼ï¼šå…³é—­';
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setInitialTimes();
            loadSavedConfig();
        });
    </script>
</body>
</html> 