<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIÂä©ÊâãÁæ§ËÅä - ÁúüÂÆûAPIÁâàÊú¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .api-config {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .api-config h3 {
            color: #374151;
            margin-bottom: 15px;
        }

        .api-input-group {
            margin-bottom: 15px;
        }

        .api-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }

        .api-input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .api-input-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .toggle-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
        }

        .toggle-button:hover {
            background: #2563eb;
        }

        .toggle-button.active {
            background: #10b981;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .assistant-list {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .assistant-list h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 15px;
        }

        .assistant-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: border-color 0.2s;
        }

        .assistant-item:hover {
            border-color: #d1d5db;
        }

        .assistant-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
            font-weight: 600;
        }

        .assistant-info h4 {
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .assistant-info p {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.online {
            background: #10b981;
        }

        .status-dot.offline {
            background: #ef4444;
        }

        .chat-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            height: 600px;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .chat-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .chat-header p {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 300px;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 0.875rem;
            line-height: 1.4;
            white-space: pre-wrap; /* ‰øùÁïôÊç¢Ë°å */
            word-break: break-word; /* ÈïøËØçÊç¢Ë°å */
        }

        .message.user .message-content {
            background: #3b82f6;
            color: white;
            border-bottom-right-radius: 6px;
        }

        .message.assistant .message-content {
            background: white;
            color: #374151;
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 6px;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
            font-weight: 600;
        }

        .message-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .message-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
        }

        .message-time {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: #3b82f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .loading {
            display: flex;
            justify-content: center;
            gap: 4px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            background: #9ca3af;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .chat-input {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .input-form {
            display: flex;
            gap: 12px;
        }

        .input-field {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.875rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .send-button {
            padding: 12px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .send-button:hover {
            background: #2563eb;
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .send-icon {
            width: 16px;
            height: 16px;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ AIÂä©ÊâãÁæ§ËÅä - ÁúüÂÆûAPIÁâàÊú¨</h1>
            <p>ÈÖçÁΩÆÁúüÂÆûÁöÑAI APIÂØÜÈí•Ôºå‰ΩìÈ™åÁúüÂÆûÁöÑAIÂØπËØù</p>
        </div>

        <!-- APIÈÖçÁΩÆÂå∫Âüü -->
        <div class="api-config">
            <h3>üîë APIÈÖçÁΩÆ</h3>
            <div class="api-input-group">
                <label for="deepseekApiKey">DeepSeek API Key:</label>
                <input type="password" id="deepseekApiKey" placeholder="ËæìÂÖ•‰Ω†ÁöÑDeepSeek APIÂØÜÈí•">
            </div>
            <div class="api-input-group">
                <label for="tongyiApiKey">ÈÄö‰πâÂçÉÈóÆ API Key:</label>
                <input type="password" id="tongyiApiKey" placeholder="ËæìÂÖ•‰Ω†ÁöÑÈÄö‰πâÂçÉÈóÆAPIÂØÜÈí•">
            </div>
            <div class="api-input-group">
                <label for="doubaoApiKey">Ë±ÜÂåÖ API Key:</label>
                <input type="password" id="doubaoApiKey" placeholder="ËæìÂÖ•‰Ω†ÁöÑË±ÜÂåÖAPIÂØÜÈí•">
            </div>
            <button id="defaultKeyToggle" class="toggle-button" type="button">‰ΩøÁî®ÈªòËÆ§KeyÊ®°ÂºèÔºöÂÖ≥Èó≠</button>
            <button id="plainTextToggle" class="toggle-button active" type="button">Á∫ØÊñáÊú¨ÊòæÁ§∫ÔºöÂºÄÂêØ</button>
            <button id="conciseModeToggle" class="toggle-button" type="button">ÁÆÄÊ¥ÅÊ®°ÂºèÔºöÂÖ≥Èó≠</button>
            
            <!-- API-only Ê®°ÂºèÔºåÂ∑≤ÁßªÈô§Ê®°Êãü/ÁúüÂÆûÂàáÊç¢ -->
            
            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </div>

        <div class="main-content">
            <div class="assistant-list">
                <h3>AIÂä©ÊâãÁæ§ÁªÑ</h3>
                <div class="assistant-item">
                    <div class="assistant-avatar" style="background-color: #3B82F6;">ü§ñ</div>
                    <div class="assistant-info">
                        <h4>DeepSeek</h4>
                        <p>Âº∫Â§ßÁöÑAIÂä©ÊâãÔºåÊìÖÈïø‰ª£Á†ÅÁîüÊàêÂíåÈóÆÈ¢òËß£Á≠î</p>
                    </div>
                    <div class="status-dot" id="deepseekStatus"></div>
                </div>
                <div class="assistant-item">
                    <div class="assistant-avatar" style="background-color: #10B981;">üß†</div>
                    <div class="assistant-info">
                        <h4>ÈÄö‰πâÂçÉÈóÆ</h4>
                        <p>ÈòøÈáå‰∫ëÊô∫ËÉΩÂä©ÊâãÔºåÁü•ËØÜÊ∏äÂçöÔºåÂõûÁ≠îÂáÜÁ°Æ</p>
                    </div>
                    <div class="status-dot" id="tongyiStatus"></div>
                </div>
                        <div class="assistant-item">
            <div class="assistant-avatar" style="background-color: #FF6B35;">üçú</div>
            <div class="assistant-info">
                <h4>Ë±ÜÂåÖ</h4>
                <p>Â≠óËäÇË∑≥Âä®ÁöÑAIÂä©ÊâãÔºåÁü•ËØÜ‰∏∞ÂØåÔºåÂõûÁ≠îÂáÜÁ°Æ</p>
            </div>
            <div class="status-dot" id="doubaoStatus"></div>
        </div>
            </div>

            <div class="chat-container">
                <div class="chat-header">
                    <h2>AIÂä©ÊâãÁæ§ËÅä</h2>
                    <p id="onlineCount">3 ‰∏™AIÂä©ÊâãÂú®Á∫ø</p>
                </div>

                <div class="messages-container" id="messagesContainer">
                    <div class="message assistant">
                        <div class="message-avatar" style="background-color: #3B82F6;">ü§ñ</div>
                        <div class="message-content">
                            <div class="message-info">
                                <span class="message-name">DeepSeek</span>
                                <span class="message-time" id="time1"></span>
                            </div>
                            <p>Ê¨¢ËøéÊù•Âà∞AIÂä©ÊâãÁæ§ËÅäÔºÅÊàëÊòØDeepSeekÔºåÂæàÈ´òÂÖ¥‰∏∫‰Ω†Êèê‰æõÂ∏ÆÂä©ÔºÅ</p>
                        </div>
                    </div>
                    <div class="message assistant">
                        <div class="message-avatar" style="background-color: #10B981;">üß†</div>
                        <div class="message-content">
                            <div class="message-info">
                                <span class="message-name">ÈÄö‰πâÂçÉÈóÆ</span>
                                <span class="message-time" id="time2"></span>
                            </div>
                            <p>‰Ω†Â•ΩÔºÅÊàëÊòØÈÄö‰πâÂçÉÈóÆÔºåÊù•Ëá™ÈòøÈáå‰∫ë„ÄÇÊàëÂèØ‰ª•Â∏ÆÂä©‰Ω†Ëß£Á≠îÂêÑÁßçÈóÆÈ¢òÔºÅ</p>
                        </div>
                    </div>
                    <div class="message assistant">
                        <div class="message-avatar" style="background-color: #FF6B35;">üçú</div>
                        <div class="message-content">
                            <div class="message-info">
                                <span class="message-name">Ë±ÜÂåÖ</span>
                                <span class="message-time" id="time3"></span>
                            </div>
                            <p>‰Ω†Â•ΩÔºÅÊàëÊòØË±ÜÂåÖÔºåÊù•Ëá™Â≠óËäÇË∑≥Âä®„ÄÇÊàëÁü•ËØÜ‰∏∞ÂØåÔºåÂèØ‰ª•Â∏Æ‰Ω†Ëß£Á≠îÂêÑÁßçÈóÆÈ¢òÔºÅ</p>
                        </div>
                    </div>
                </div>

                <div class="chat-input">
                    <form class="input-form" id="chatForm">
                        <input 
                            type="text" 
                            class="input-field" 
                            id="messageInput" 
                            placeholder="ËæìÂÖ•‰Ω†ÁöÑÈóÆÈ¢ò..."
                            required
                        >
                        <button type="submit" class="send-button" id="sendButton">
                            <svg class="send-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                            ÂèëÈÄÅ
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáèÔºàAPI-only Ê®°ÂºèÔºâ
        let apiKeys = {
            deepseek: '',
            tongyi: '',
            doubao: ''
        };

        // ÈªòËÆ§KeyÊ®°ÂºèÔºàÁî®‰∫éÊºîÁ§∫/Âø´ÈÄü‰ΩìÈ™åÔºâ
        let useDefaultKeys = false;
        const defaultApiKeys = {
            deepseek: 'sk-11a35677deac466c9870cc2f378b7a8d',
            tongyi: 'sk-25589eb8818943cabe6d1356da901cd4',
            doubao: '0d76b879-92cf-4964-ba29-380e452e9908'
        };

        // ÁÆÄÊ¥ÅÊ®°ÂºèÂºÄÂÖ≥ÔºåÈªòËÆ§ÂÖ≥Èó≠
        let useConciseMode = false;

        // ‰∏â‰∏™ÂÆòÁΩë API Âú∞ÂùÄÔºàÈõÜ‰∏≠ÁÆ°ÁêÜÔºâ
        const apiEndpoints = {
            deepseek: 'https://api.deepseek.com/v1/chat/completions',
            tongyi: 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',
            doubao: 'https://ark.cn-beijing.volces.com/api/v3/chat/completions'
        };

        // Á∫ØÊñáÊú¨ÊòæÁ§∫ÔºàÂæÆ‰ø°ËÅäÂ§©È£éÊ†ºÔºâÂºÄÂÖ≥ÔºåÈªòËÆ§ÂºÄÂêØ
        let usePlainText = true;

        // ËÅäÂ§©ÂéÜÂè≤ÔºàÁî®‰∫é‰∏ä‰∏ãÊñáÔºâ
        // ‰ΩøÁî® OpenAI ÂÖºÂÆπÁöÑ { role, content } ÁªìÊûÑ
        const chatHistory = [];

        // Ëé∑ÂèñÊúÄËøë N Êù°Ê∂àÊÅØÔºåÂπ∂ÂèØÈÄâÊ∑ªÂä†Á≥ªÁªüÊèêÁ§∫
        function getRecentMessages(limit = 20, systemPrompt = null) {
            const startIndex = Math.max(chatHistory.length - limit, 0);
            const recent = chatHistory.slice(startIndex);
            // ÁÆÄÊ¥ÅÊ®°Âºè‰∏ãÁöÑÁ≥ªÁªüÊèêÁ§∫
            let finalSystemPrompt = systemPrompt;
            if (useConciseMode) {
                const concisePrompt = "‰Ω†ÊòØ‰∏Ä‰∏™ÂèãÂ•ΩÁöÑÊúãÂèãÔºåËØ∑Áî®ÁÆÄÊ¥ÅÁöÑËØ≠Ë®ÄÂõûÂ§çÔºåÊØèÊ¨°Âè™ÂõûÂ§ç1-2Âè•ËØùÔºå‰øùÊåÅÂØπËØùÁöÑËá™ÁÑ∂ÊµÅÁïÖ„ÄÇ";
                finalSystemPrompt = finalSystemPrompt ? `${finalSystemPrompt}\n\n${concisePrompt}` : concisePrompt;
            }
            if (finalSystemPrompt) {
                return [{ role: 'system', content: finalSystemPrompt }, ...recent];
            }
            return recent;
        }

        // ËÆæÁΩÆÂàùÂßãÊ∂àÊÅØÊó∂Èó¥
        function setInitialTimes() {
            const now = new Date();
            const time1 = document.getElementById('time1');
            const time2 = document.getElementById('time2');
            const time3 = document.getElementById('time3');
            
            time1.textContent = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            time2.textContent = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            time3.textContent = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }

        // Â∑≤ÁßªÈô§Ê®°ÂºèÂàáÊç¢ÔºàÂõ∫ÂÆö‰∏∫ÁúüÂÆûAPIÊ®°ÂºèÔºâ

        // Êõ¥Êñ∞Áä∂ÊÄÅÊòæÁ§∫
        function updateStatus() {
            const deepseekStatus = document.getElementById('deepseekStatus');
            const tongyiStatus = document.getElementById('tongyiStatus');
            const doubaoStatus = document.getElementById('doubaoStatus');
            
            const effectiveKeys = getEffectiveKeys();
            deepseekStatus.className = 'status-dot ' + (effectiveKeys.deepseek ? 'online' : 'offline');
            tongyiStatus.className = 'status-dot ' + (effectiveKeys.tongyi ? 'online' : 'offline');
            doubaoStatus.className = 'status-dot ' + (effectiveKeys.doubao ? 'online' : 'offline');
            
            // Êõ¥Êñ∞Âú®Á∫øÊï∞Èáè
            const onlineCount = document.getElementById('onlineCount');
            const onlineAssistants = Object.values(effectiveKeys).filter(key => key).length;
            onlineCount.textContent = `${onlineAssistants} ‰∏™AIÂä©ÊâãÂú®Á∫ø`;
        }

        // Ëé∑ÂèñÊúâÊïàKeyÔºö‰ºòÂÖàÁî®Êà∑ËæìÂÖ•ÔºåÂÖ∂Ê¨°ÈªòËÆ§Key
        function getEffectiveKeys() {
            return {
                deepseek: apiKeys.deepseek || defaultApiKeys.deepseek,
                tongyi: apiKeys.tongyi || defaultApiKeys.tongyi,
                doubao: apiKeys.doubao || defaultApiKeys.doubao
            };
        }

        // ‰øùÂ≠òAPIÂØÜÈí•
        function saveApiKeys() {
            apiKeys.deepseek = document.getElementById('deepseekApiKey').value;
            apiKeys.tongyi = document.getElementById('tongyiApiKey').value;
            apiKeys.doubao = document.getElementById('doubaoApiKey').value;
            
            // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
            localStorage.setItem('aiChatApiKeys', JSON.stringify(apiKeys));
            
            updateStatus();
        }

        // Âä†ËΩΩ‰øùÂ≠òÁöÑÈÖçÁΩÆ
        function loadSavedConfig() {
            const savedKeys = localStorage.getItem('aiChatApiKeys');
            
            if (savedKeys) {
                apiKeys = JSON.parse(savedKeys);
                document.getElementById('deepseekApiKey').value = apiKeys.deepseek;
                document.getElementById('tongyiApiKey').value = apiKeys.tongyi;
                document.getElementById('doubaoApiKey').value = apiKeys.doubao;
            }
            const savedUseDefault = localStorage.getItem('aiChatUseDefaultKeys');
            if (savedUseDefault) {
                useDefaultKeys = savedUseDefault === 'true';
            }
            const toggleBtn = document.getElementById('defaultKeyToggle');
            if (useDefaultKeys) {
                toggleBtn.classList.add('active');
                toggleBtn.textContent = '‰ΩøÁî®ÈªòËÆ§KeyÊ®°ÂºèÔºöÂºÄÂêØ';
            } else {
                toggleBtn.classList.remove('active');
                toggleBtn.textContent = '‰ΩøÁî®ÈªòËÆ§KeyÊ®°ÂºèÔºöÂÖ≥Èó≠';
            }
            
            updateStatus();

            const savedPlain = localStorage.getItem('aiChatUsePlainText');
            if (savedPlain) {
                usePlainText = savedPlain === 'true';
            }
            const plainBtn = document.getElementById('plainTextToggle');
            if (usePlainText) {
                plainBtn.classList.add('active');
                plainBtn.textContent = 'Á∫ØÊñáÊú¨ÊòæÁ§∫ÔºöÂºÄÂêØ';
            } else {
                plainBtn.classList.remove('active');
                plainBtn.textContent = 'Á∫ØÊñáÊú¨ÊòæÁ§∫ÔºöÂÖ≥Èó≠';
            }

            const savedConcise = localStorage.getItem('aiChatUseConciseMode');
            if (savedConcise) {
                useConciseMode = savedConcise === 'true';
            }
            const conciseBtn = document.getElementById('conciseModeToggle');
            if (useConciseMode) {
                conciseBtn.classList.add('active');
                conciseBtn.textContent = 'ÁÆÄÊ¥ÅÊ®°ÂºèÔºöÂºÄÂêØ';
            } else {
                conciseBtn.classList.remove('active');
                conciseBtn.textContent = 'ÁÆÄÊ¥ÅÊ®°ÂºèÔºöÂÖ≥Èó≠';
            }
        }

        // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // AIÂä©ÊâãÈÖçÁΩÆÔºàAPI-onlyÔºâ
        const assistants = [
            { id: 'deepseek', name: 'DeepSeek', avatar: 'ü§ñ', color: '#3B82F6' },
            { id: 'tongyi', name: 'ÈÄö‰πâÂçÉÈóÆ', avatar: 'üß†', color: '#10B981' },
            { id: 'doubao', name: 'Ë±ÜÂåÖ', avatar: 'üçú', color: '#FF6B35' }
        ];

        // Â∑≤ÁßªÈô§Ê®°ÊãüAIÊ®°Âùó

        // Ë∞ÉÁî®ÁúüÂÆûAPI
        async function callRealAPI(messages, assistantId) {
            // ËøôÈáåÈúÄË¶ÅÊ†πÊçÆÂÆûÈôÖÁöÑAPIÊñáÊ°£Êù•ÂÆûÁé∞
            // ‰ª•‰∏ãÊòØÁ§∫‰æã‰ª£Á†ÅÔºå‰Ω†ÈúÄË¶ÅÊ†πÊçÆÂÆûÈôÖÊÉÖÂÜµ‰øÆÊîπ
            
            try {
                switch(assistantId) {
                    case 'deepseek':
                        if (!getEffectiveKeys().deepseek) {
                            throw new Error('DeepSeek APIÂØÜÈí•Êú™ÈÖçÁΩÆ');
                        }
                        // Ë∞ÉÁî®DeepSeek API
                        return await callDeepSeekAPI(messages, getEffectiveKeys().deepseek);
                        
                    case 'tongyi':
                        if (!getEffectiveKeys().tongyi) {
                            throw new Error('ÈÄö‰πâÂçÉÈóÆAPIÂØÜÈí•Êú™ÈÖçÁΩÆ');
                        }
                        // Ë∞ÉÁî®ÈÄö‰πâÂçÉÈóÆAPI
                        return await callTongyiAPI(messages, getEffectiveKeys().tongyi);
                        
                    case 'doubao':
                        if (!getEffectiveKeys().doubao) {
                            throw new Error('Ë±ÜÂåÖAPIÂØÜÈí•Êú™ÈÖçÁΩÆ');
                        }
                        // Ë∞ÉÁî®Ë±ÜÂåÖAPI
                        return await calldoubaoAPI(messages, getEffectiveKeys().doubao);
                        
                    default:
                        throw new Error('Êú™Áü•ÁöÑAIÂä©Êâã');
                }
            } catch (error) {
                console.error(`Ë∞ÉÁî®${assistantId} APIÂ§±Ë¥•:`, error);
                return `Êä±Ê≠âÔºåË∞ÉÁî®${assistantId} APIÊó∂Âá∫Áé∞ÈîôËØØ: ${error.message}`;
            }
        }

        // Á§∫‰æãAPIË∞ÉÁî®ÂáΩÊï∞ÔºàÈúÄË¶ÅÊ†πÊçÆÂÆûÈôÖAPIÊñáÊ°£‰øÆÊîπÔºâ
        async function callDeepSeekAPI(messages, apiKey) {
            // ËøôÈáåÈúÄË¶ÅÊ†πÊçÆDeepSeekÁöÑÂÆûÈôÖAPIÊñáÊ°£Êù•ÂÆûÁé∞
            // Á§∫‰æãÔºö
            const requestBody = {
                model: 'deepseek-chat',
                messages: messages
            };
            
            // ÁÆÄÊ¥ÅÊ®°Âºè‰∏ãÈôêÂà∂ÂõûÂ§çÈïøÂ∫¶
            if (useConciseMode) {
                requestBody.max_tokens = 100;
                requestBody.temperature = 0.7;
            }
            
            const response = await fetch(apiEndpoints.deepseek, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                throw new Error(`APIË∞ÉÁî®Â§±Ë¥•: ${response.status}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }

        async function callTongyiAPI(messages, apiKey) {
            // DashScope ÂÖºÂÆπÊ®°ÂºèÔºàOpenAI È£éÊ†ºÔºâ
            const requestBody = {
                model: 'qwen-plus',
                messages: messages
            };
            
            // ÁÆÄÊ¥ÅÊ®°Âºè‰∏ãÈôêÂà∂ÂõûÂ§çÈïøÂ∫¶
            if (useConciseMode) {
                requestBody.max_tokens = 100;
                requestBody.temperature = 0.7;
            }
            
            const response = await fetch(apiEndpoints.tongyi, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`APIË∞ÉÁî®Â§±Ë¥•: ${response.status} - ${errorText}`);
            }
            
            const data = await response.json();
            const content = data?.choices?.[0]?.message?.content;
            if (content) return content;
            throw new Error('APIÂìçÂ∫îÊ†ºÂºè‰∏çÊ≠£Á°Æ');
        }

        async function calldoubaoAPI(messages, apiKey) {
            // Ë±ÜÂåÖAPIË∞ÉÁî® - Â∞ùËØïÂ§ö‰∏™ÂèØËÉΩÁöÑÊ®°ÂûãÂêçÁß∞
            const possibleModels = [
                "doubao-seed-1-6-250615",
            ];
            
            for (const model of possibleModels) {
                try {
                    console.log(`Â∞ùËØïË±ÜÂåÖÊ®°Âûã: ${model}`);
                    
                    const requestBody = {
                        model: model,
                        messages: messages,
                        max_tokens: 1000,
                        temperature: 0.7
                    };
                    
                    // ÁÆÄÊ¥ÅÊ®°Âºè‰∏ãËøõ‰∏ÄÊ≠•ÈôêÂà∂ÂõûÂ§çÈïøÂ∫¶
                    if (useConciseMode) {
                        requestBody.max_tokens = 100;
                    }
                    
                    const response = await fetch(apiEndpoints.doubao, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.log(`Ê®°Âûã ${model} Â§±Ë¥•: ${response.status} - ${errorText}`);
                        continue; // Â∞ùËØï‰∏ã‰∏Ä‰∏™Ê®°Âûã
                    }
                    
                    const data = await response.json();
                    console.log(`Ê®°Âûã ${model} ÊàêÂäü!`);
                    
                    // Ê†πÊçÆË±ÜÂåÖAPIÁöÑÂìçÂ∫îÊ†ºÂºèËß£Êûê
                    if (data.choices && data.choices[0] && data.choices[0].message) {
                        return data.choices[0].message.content;
                    } else if (data.output && data.output.text) {
                        return data.output.text;
                    } else {
                        throw new Error('APIÂìçÂ∫îÊ†ºÂºè‰∏çÊ≠£Á°Æ');
                    }
                } catch (error) {
                    console.log(`Ê®°Âûã ${model} Âá∫Èîô:`, error.message);
                    continue; // Â∞ùËØï‰∏ã‰∏Ä‰∏™Ê®°Âûã
                }
            }
            
            // ÊâÄÊúâÊ®°ÂûãÈÉΩÂ§±Ë¥•‰∫Ü
            throw new Error('ÊâÄÊúâË±ÜÂåÖÊ®°ÂûãÈÉΩÊó†Ê≥ïËÆøÈóÆÔºåËØ∑Ê£ÄÊü•APIÂØÜÈí•ÂíåÊùÉÈôê');
        }

        // Ê∑ªÂä†Ê∂àÊÅØÂà∞ËÅäÂ§©ÁïåÈù¢
        function addMessage(content, sender, assistantId = null) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            if (sender === 'user') {
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                if (usePlainText) {
                    contentDiv.textContent = content;
                } else {
                    contentDiv.innerHTML = `<p>${content}</p>`;
                }
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'user-avatar';
                avatarDiv.textContent = 'Êàë';
                messageDiv.appendChild(contentDiv);
                messageDiv.appendChild(avatarDiv);
            } else {
                const assistant = assistants.find(a => a.id === assistantId);
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.style.backgroundColor = assistant.color;
                avatar.textContent = assistant.avatar;
                const contentWrap = document.createElement('div');
                contentWrap.className = 'message-content';
                const info = document.createElement('div');
                info.className = 'message-info';
                const nameSpan = document.createElement('span');
                nameSpan.className = 'message-name';
                nameSpan.textContent = assistant.name;
                const timeSpan = document.createElement('span');
                timeSpan.className = 'message-time';
                timeSpan.textContent = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                info.appendChild(nameSpan);
                info.appendChild(timeSpan);
                contentWrap.appendChild(info);
                const p = document.createElement('p');
                if (usePlainText) {
                    p.textContent = content;
                } else {
                    p.innerHTML = content;
                }
                contentWrap.appendChild(p);
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(contentWrap);
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        function showLoading() {
            const messagesContainer = document.getElementById('messagesContainer');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.id = 'loading';
            loadingDiv.innerHTML = `
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            `;
            messagesContainer.appendChild(loadingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.remove();
            }
        }

        // Â§ÑÁêÜË°®ÂçïÊèê‰∫§
        document.getElementById('chatForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
            addMessage(message, 'user');
            // ÂÜôÂÖ•ÂéÜÂè≤‰Ωú‰∏∫‰∏ä‰∏ãÊñá
            chatHistory.push({ role: 'user', content: message });
            input.value = '';
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            showLoading();
            
            try {
                let remaining = assistants.length;
                assistants.forEach(async (assistant) => {
                    try {
                        // ÂèØÈÄâÁ≥ªÁªüÊèêÁ§∫ÔºåÂèØÊåâÈúÄÂÆöÂà∂‰∏çÂêåÂä©ÊâãË∫´‰ªΩ
                        const systemPrompt = null;
                        const messagesWithContext = getRecentMessages(20, systemPrompt);
                        const response = await callRealAPI(messagesWithContext, assistant.id);
                        addMessage(response, 'assistant', assistant.id);
                        // Â∞ÜÂä©ÊâãÂõûÂ§çÂÜôÂÖ•ÂéÜÂè≤
                        chatHistory.push({ role: 'assistant', content: response });
                    } catch (error) {
                        addMessage(`ÈîôËØØ: ${error.message}`, 'assistant', assistant.id);
                    } finally {
                        remaining -= 1;
                        if (remaining === 0) {
                            hideLoading();
                        }
                    }
                });
            } catch (error) {
                hideLoading();
                showError(`ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•: ${error.message}`);
            }
        });

        // ÁõëÂê¨APIÂØÜÈí•ËæìÂÖ•ÂèòÂåñ
        document.getElementById('deepseekApiKey').addEventListener('input', saveApiKeys);
        document.getElementById('tongyiApiKey').addEventListener('input', saveApiKeys);
        document.getElementById('doubaoApiKey').addEventListener('input', saveApiKeys);
        // ÁõëÂê¨ÈªòËÆ§KeyÊ®°ÂºèÂàáÊç¢
        document.getElementById('defaultKeyToggle').addEventListener('click', function() {
            useDefaultKeys = !useDefaultKeys;
            localStorage.setItem('aiChatUseDefaultKeys', useDefaultKeys ? 'true' : 'false');
            const toggleBtn = document.getElementById('defaultKeyToggle');
            if (useDefaultKeys) {
                toggleBtn.classList.add('active');
                toggleBtn.textContent = '‰ΩøÁî®ÈªòËÆ§KeyÊ®°ÂºèÔºöÂºÄÂêØ';
            } else {
                toggleBtn.classList.remove('active');
                toggleBtn.textContent = '‰ΩøÁî®ÈªòËÆ§KeyÊ®°ÂºèÔºöÂÖ≥Èó≠';
            }
            updateStatus();
        });

        // ÁõëÂê¨Á∫ØÊñáÊú¨ÊòæÁ§∫ÂàáÊç¢
        document.getElementById('plainTextToggle').addEventListener('click', function() {
            usePlainText = !usePlainText;
            localStorage.setItem('aiChatUsePlainText', usePlainText ? 'true' : 'false');
            const btn = document.getElementById('plainTextToggle');
            if (usePlainText) {
                btn.classList.add('active');
                btn.textContent = 'Á∫ØÊñáÊú¨ÊòæÁ§∫ÔºöÂºÄÂêØ';
            } else {
                btn.classList.remove('active');
                btn.textContent = 'Á∫ØÊñáÊú¨ÊòæÁ§∫ÔºöÂÖ≥Èó≠';
            }
        });

        // ÁõëÂê¨ÁÆÄÊ¥ÅÊ®°ÂºèÂàáÊç¢
        document.getElementById('conciseModeToggle').addEventListener('click', function() {
            useConciseMode = !useConciseMode;
            localStorage.setItem('aiChatUseConciseMode', useConciseMode ? 'true' : 'false');
            const btn = document.getElementById('conciseModeToggle');
            if (useConciseMode) {
                btn.classList.add('active');
                btn.textContent = 'ÁÆÄÊ¥ÅÊ®°ÂºèÔºöÂºÄÂêØ';
            } else {
                btn.classList.remove('active');
                btn.textContent = 'ÁÆÄÊ¥ÅÊ®°ÂºèÔºöÂÖ≥Èó≠';
            }
        });

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            setInitialTimes();
            loadSavedConfig();
        });
    </script>
</body>
</html> 